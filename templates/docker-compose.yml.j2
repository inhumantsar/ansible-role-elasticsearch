version: "3.2"

services:
  elasticsearch:
    image: {{ elasticsearch_docker_image }}:{{ elasticsearch_version }}
    deploy:
      mode: replicated
      replicas: {{ elasticsearch_num_nodes }}
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
    volumes:
      - {{ elasticsearch_logs_hostpath }}:/var/log/elasticsearch
      - {{ elasticsearch_data_hostpath }}:/var/data/elasticsearch
    environment:
      - "cluster.name={{ elasticsearch_cluster_name }}"
      - "network.host={{ elasticsearch_network_host }}"
      - "gateway.expected_nodes={{ elasticsearch_num_nodes }}"
      - "discovery.zen.minimum_master_nodes={{ elasticsearch_zen_min_masters }}"
    # see also:
    #   * Heap Size. Default: 1G.
    #   * Heap Dump Path. Default: /var/lib/elasticsearch https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-dump-path.html#heap-dump-path
    #   *
{% if elasticsearch_kibana %}
  kibana:
    image: {{ elasticsearch_kibana_docker_image }}:{{ elasticsearch_version }}
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
{% if elasticsearch_kibana_deploy_labels %}
{% for label in elasticsearch_kibana_deploy_labels %}
        - {{ label }}
{% endfor %}
{%- endif %}
    ports:
      - "5601:{{ elasticsearch_kibana_hostport }}"
    volumes:
      - "{{ elasticsearch_kibana_data_hostpath }}:/usr/share/kibana/data"
    environment:
      - "ELASTICSEARCH_URL=http://elasticsearch:9200"
      - "SERVER_HOST={{ elasticsearch_kibana_network_host }}"
      - "XPACK_REPORTING_ENABLED=false"
{%- endif %}